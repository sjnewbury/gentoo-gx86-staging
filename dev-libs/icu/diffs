--- /usr/portage/dev-libs/icu/icu-52.1.ebuild	2014-01-01 21:03:36.000000000 +0000
+++ icu-52.1-r1.ebuild	2013-11-15 15:04:02.000000000 +0000
@@ -1,10 +1,10 @@
-# Copyright 1999-2014 Gentoo Foundation
+# Copyright 1999-2013 Gentoo Foundation
 # Distributed under the terms of the GNU General Public License v2
-# $Header: /var/cvsroot/gentoo-x86/dev-libs/icu/icu-52.1.ebuild,v 1.1 2014/01/01 21:03:36 dilfridge Exp $
+# $Header: /var/cvsroot/gentoo-x86/dev-libs/icu/icu-51.2-r1.ebuild,v 1.11 2013/11/12 20:12:53 ago Exp $
 
 EAPI=5
 
-inherit eutils toolchain-funcs autotools multilib-minimal
+inherit eutils toolchain-funcs base autotools multilib-minimal
 
 DESCRIPTION="International Components for Unicode"
 HOMEPAGE="http://www.icu-project.org/"
@@ -12,9 +12,13 @@
 
 LICENSE="BSD"
 
-SLOT="0/52"
+SLOT="0/51.2"
+# As far as I can remember, icu consumers reacted rather sensitive to icu upgrades in the past. 
+# Even if revdep-rebuild did not rebuild (i.e. soname did not change), random crashes and 
+# other irregularities occured until the consumers were rebuilt. So let's rather err on the side
+# of caution and more rebuilds here. See also bug 464876. dilfridge
 
-KEYWORDS="~alpha ~amd64 ~arm ~hppa ~ia64 ~mips ~ppc ~ppc64 ~s390 ~sh ~sparc ~x86 ~amd64-fbsd ~x86-fbsd"
+KEYWORDS="alpha amd64 arm hppa ia64 ~mips ppc ppc64 ~s390 ~sh sparc x86 ~amd64-fbsd ~x86-fbsd"
 IUSE="debug doc examples static-libs"
 
 DEPEND="
@@ -25,10 +29,16 @@
 
 S="${WORKDIR}/${PN}/source"
 
+PATCHES=(
+	"${FILESDIR}/${PN}-51.1-CVE-2013-2924.patch"
+)
+
+ECONF_SOURCE="${S}"
+
 src_prepare() {
 	local variable
 
-	epatch_user
+	base_src_prepare
 
 	# Do not hardcode flags in icu-config and icu-*.pc files.
 	# https://ssl.icu-project.org/trac/ticket/6102
@@ -53,54 +63,40 @@
 	# Append doxygen configuration to configure
 	sed -i \
 		-e 's:icudefs.mk:icudefs.mk Doxyfile:' \
-		configure.ac || die
+		configure.in || die
 	eautoreconf
 }
 
-src_configure() {
-	if tc-is-cross-compiler; then
-		mkdir "${WORKDIR}"/host || die
-		pushd "${WORKDIR}"/host >/dev/null || die
+multilib_src_configure() {
+	local cross_opts
 
+	# bootstrap for cross compilation
+	if tc-is-cross-compiler; then
 		CFLAGS="" CXXFLAGS="" ASFLAGS="" LDFLAGS="" \
 		CC="$(tc-getBUILD_CC)" CXX="$(tc-getBUILD_CXX)" AR="$(tc-getBUILD_AR)" \
 		RANLIB="$(tc-getBUILD_RANLIB)" LD="$(tc-getBUILD_LD)" \
-		"${S}"/configure --disable-renaming --disable-debug \
+		./configure --disable-renaming --disable-debug \
 			--disable-samples --enable-static || die
 		emake
+		mkdir -p "${WORKDIR}/host/"
+		cp -a {bin,lib,config,tools} "${WORKDIR}/host/"
+		emake clean
 
-		popd >/dev/null || die
+		cross_opts="--with-cross-build=${WORKDIR}/host"
 	fi
 
-	multilib-minimal_src_configure
-}
-
-multilib_src_configure() {
-	local myeconfargs=(
-		--disable-renaming
-		--disable-samples
-		$(use_enable debug)
-		$(use_enable static-libs static)
-	)
-
-	multilib_build_binaries && myeconfargs+=(
-		$(use_enable examples samples)
-	)
-	tc-is-cross-compiler && myeconfargs+=(
-		--with-cross-build="${WORKDIR}"/host
-	)
-
-	# icu tries to use clang by default
-	tc-export CC CXX
-
-	ECONF_SOURCE=${S} \
-	econf "${myeconfargs[@]}"
+	econf \
+		--disable-renaming \
+		$(use_enable debug) \
+		$(use_enable examples samples) \
+		$(use_enable static-libs static) \
+		${cross_opts}
 }
 
 multilib_src_compile() {
 	default
 
-	if multilib_build_binaries && use doc; then
+	if use doc; then
 		doxygen -u Doxyfile || die
 		doxygen Doxyfile || die
 	fi
@@ -120,15 +116,8 @@
 	emake -j1 VERBOSE="1" check
 }
 
-multilib_src_install() {
-	default
-
-	if multilib_build_binaries && use doc; then
-		dohtml -p api -r doc/html/
-	fi
-}
-
 multilib_src_install_all() {
-	einstalldocs
 	dohtml ../readme.html
+
+	use doc && dohtml -p api -r doc/html/
 }
